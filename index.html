<script type="module">
        // --- FIX: setLogLevel is now imported from firebase-app, not firestore ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // The incorrect import of setLogLevel from here has been removed.

        // This listener ensures all HTML is loaded before the script tries to find buttons or other elements.
        document.addEventListener('DOMContentLoaded', () => {

            // Set log level to debug for development purposes
            setLogLevel('debug'); // Changed to lowercase 'debug' which is the standard value
            
            // Use the global variables provided by the Canvas environment
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            let db, auth;
            let userId;
            let logsUnsubscribe;

            // Message box elements
            const messageModal = document.getElementById('message-modal');
            const messageContent = document.getElementById('message-content');
            const closeModalBtn = document.getElementById('close-modal-btn');

            // Function to show a custom message modal instead of alert()
            function showMessageModal(message) {
                messageContent.textContent = message;
                messageModal.classList.remove('hidden');
            }

            closeModalBtn.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessageModal("Could not connect to the database. Please check your configuration.");
                return; // Stop execution if Firebase fails
            }

            // UI elements
            const mainContainer = document.getElementById('main-container');
            const logbookContainer = document.getElementById('logbook-container');
            const showCalculatorBtn = document.getElementById('show-calculator-btn');
            const showLogsBtn = document.getElementById('show-logs-btn');
            const userIdDisplay = document.getElementById('user-id-display');
            const logCarbsInput = document.getElementById('log-carbs-input');
            const feedbackTextarea = document.getElementById('feedback-textarea');
            const saveLogBtn = document.getElementById('save-log-btn');
            const logsList = document.getElementById('logs-list');
            const logStatus = document.getElementById('log-status');

            // State to hold calculated totals
            let lastCalculatedCarbs = 0;

            // Function to switch between calculator and logbook views
            function showView(view) {
                // Remove active classes from both buttons
                showCalculatorBtn.classList.remove('view-btn-active', 'bg-blue-500', 'text-white');
                showLogsBtn.classList.remove('view-btn-active', 'bg-blue-500', 'text-white');
                showCalculatorBtn.classList.add('bg-gray-200', 'text-gray-800');
                showLogsBtn.classList.add('bg-gray-200', 'text-gray-800');

                if (view === 'calculator') {
                    mainContainer.classList.remove('hidden-content');
                    logbookContainer.classList.add('hidden-content');
                    showCalculatorBtn.classList.add('view-btn-active');
                    showCalculatorBtn.classList.remove('bg-gray-200', 'text-gray-800');
                } else {
                    mainContainer.classList.add('hidden-content');
                    logbookContainer.classList.remove('hidden-content');
                    showLogsBtn.classList.add('view-btn-active');
                    showLogsBtn.classList.remove('bg-gray-200', 'text-gray-800');
                }
            }

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`; // Shorten for display
                    userIdDisplay.classList.remove('hidden');
                    // Fetch and display logs for the authenticated user
                    fetchAndDisplayLogs();
                } else {
                    // If no user is signed in, sign in using the custom token or anonymously
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        showMessageModal("Authentication failed. Please refresh the page.");
                    }
                }
            });

            // Function to fetch and display logs
            function fetchAndDisplayLogs() {
                if (!userId) {
                    console.warn("User ID not available yet. Skipping log fetch.");
                    return;
                }

                if (logsUnsubscribe) {
                  logsUnsubscribe(); // Detach old listener before attaching a new one
                }

                const logsCollectionPath = `/artifacts/${appId}/users/${userId}/run_logs`;
                const q = query(collection(db, logsCollectionPath));

                // Use onSnapshot for real-time updates
                logsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    const logs = [];
                    querySnapshot.forEach((doc) => {
                        logs.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort logs by timestamp in descending order (newest first)
                    logs.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                    logsList.innerHTML = '';
                    if (logs.length === 0) {
                        logsList.innerHTML = `<p class="text-gray-500 text-center py-4">No logs found. Start by calculating a recipe and logging your run!</p>`;
                    } else {
                        logs.forEach(log => {
                            const date = log.timestamp.toDate().toLocaleDateString();
                            const time = log.timestamp.toDate().toLocaleTimeString();
                            const feedbackHtml = log.feedback ? `<p class="text-sm text-gray-700 mt-1 italic">"${log.feedback}"</p>` : '';
                            const logHtml = `
                                <div class="bg-gray-50 rounded-lg p-4 shadow-sm mb-4 border-l-4 border-blue-200">
                                    <div class="flex justify-between items-center">
                                      <p class="text-lg font-bold text-gray-900">${log.carbs.toFixed(1)} g Carbs</p>
                                      <p class="text-xs text-gray-500">${date} at ${time}</p>
                                    </div>
                                    ${feedbackHtml}
                                </div>
                            `;
                            logsList.innerHTML += logHtml;
                        });
                    }
                }, (error) => {
                    console.error("Failed to fetch logs:", error);
                    showMessageModal("Could not retrieve your logs. Please try again.");
                });
            }

            // Function to save a log entry to Firestore
            async function saveLog() {
                if (!userId) {
                    showMessageModal("Please wait, the app is still authenticating...");
                    return;
                }

                const carbs = parseFloat(logCarbsInput.value);
                const feedback = feedbackTextarea.value.trim();

                if (isNaN(carbs) || carbs <= 0) {
                    showMessageModal("Please enter a valid amount of carbs to log.");
                    return;
                }

                logStatus.textContent = 'Saving log...';
                logStatus.classList.remove('hidden', 'text-green-500', 'text-red-500');

                try {
                    const logsCollectionPath = `/artifacts/${appId}/users/${userId}/run_logs`;
                    await addDoc(collection(db, logsCollectionPath), {
                        carbs: carbs,
                        feedback: feedback,
                        timestamp: Timestamp.now(),
                        userId: userId
                    });
                    logStatus.textContent = 'Log saved successfully!';
                    logStatus.classList.remove('text-red-500');
                    logStatus.classList.add('text-green-500');
                    
                    feedbackTextarea.value = '';

                    setTimeout(() => {
                        logStatus.classList.add('hidden');
                    }, 3000);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    logStatus.textContent = 'Error saving log. Please try again.';
                    logStatus.classList.remove('text-green-500');
                    logStatus.classList.add('text-red-500');
                }
            }

            // --- Calculator Logic ---
            const baseRecipe = [
                { name: 'Maltodextrin', weight: 96, carbs: 89.6, calories: 384 },
                { name: 'Fructose', weight: 64, carbs: 64, calories: 240 },
                { name: 'Pectin', weight: 2.5, carbs: 2.25, calories: 8.15 },
                { name: 'Sodium Alginate', weight: 2, carbs: 0.38, calories: 4 },
                { name: 'Water', weight: 110, carbs: 0, calories: 0 },
            ];
            const baseCarbTotal = baseRecipe.reduce((sum, item) => sum + item.carbs, 0);
            const carbsInput = document.getElementById('carbs-input');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultsArea = document.getElementById('results-area');
            const messageArea = document.getElementById('message-area');

            function showMessage(msg, isError = true) {
                messageArea.textContent = msg;
                messageArea.classList.toggle('text-red-500', isError);
                messageArea.classList.toggle('text-green-500', !isError);
                messageArea.classList.remove('hidden');
            }

            function calculateAndDisplay() {
                const desiredCarbs = parseFloat(carbsInput.value);
                if (isNaN(desiredCarbs) || desiredCarbs <= 0) {
                    showMessage('Please enter a valid number greater than 0.');
                    resultsArea.innerHTML = '';
                    return;
                }
                messageArea.classList.add('hidden');
                const scaleFactor = desiredCarbs / baseCarbTotal;
                let calculatedRecipeHtml = '';
                let totalWeight = 0, totalCarbs = 0, totalCalories = 0;

                baseRecipe.forEach(item => {
                    const newWeight = item.weight * scaleFactor;
                    const newCarbs = item.carbs * scaleFactor;
                    const newCalories = item.calories * scaleFactor;
                    totalWeight += newWeight;
                    totalCarbs += newCarbs;
                    totalCalories += newCalories;
                    calculatedRecipeHtml += `
                        <div class="bg-gray-50 rounded-lg p-4 flex justify-between items-center">
                            <span class="font-medium text-gray-800">${item.name}</span>
                            <div class="text-right">
                                <p class="text-lg font-bold text-gray-900">${newWeight.toFixed(1)} g</p>
                                <p class="text-xs text-gray-500">
                                    (${newCarbs.toFixed(1)} g carbs, ${newCalories.toFixed(1)} cal)
                                </p>
                            </div>
                        </div>`;
                });

                const totalsHtml = `
                    <div class="mt-4 bg-blue-100 rounded-lg p-4 font-bold text-blue-800 flex justify-between items-center">
                        <span>Total:</span>
                        <div class="text-right">
                            <p class="text-lg">${totalWeight.toFixed(1)} g</p>
                            <p class="text-xs">
                                (${totalCarbs.toFixed(1)} g carbs, ${totalCalories.toFixed(1)} cal)
                            </p>
                        </div>
                    </div>`;

                lastCalculatedCarbs = totalCarbs;
                logCarbsInput.value = lastCalculatedCarbs.toFixed(1);
                resultsArea.innerHTML = calculatedRecipeHtml + totalsHtml;
                resultsArea.classList.add('results-animation');
                setTimeout(() => {
                    resultsArea.classList.remove('results-animation');
                }, 300);
            }

            // --- Event Listeners ---
            showCalculatorBtn.addEventListener('click', () => showView('calculator'));
            showLogsBtn.addEventListener('click', () => showView('logs'));
            calculateBtn.addEventListener('click', calculateAndDisplay);
            carbsInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') calculateAndDisplay();
            });
            saveLogBtn.addEventListener('click', saveLog);

            // --- Initial Load ---
            calculateAndDisplay();
            showView('calculator');
        });
    </script>
